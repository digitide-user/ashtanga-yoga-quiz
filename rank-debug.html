<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ranking Debug</title>
  <script src="js/config.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Noto Sans JP, sans-serif; padding: 16px; }
    h1 { font-size: 18px; }
    .row { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
    button { padding: 8px 12px; cursor: pointer; }
    input { padding: 6px 8px; width: min(600px, 90vw); }
    pre { background: #111; color: #0f0; padding: 12px; overflow: auto; max-height: 60vh; }
    small { color: #666; }
  </style>
</head>
<body>
  <h1>Ranking Debug</h1>
  <div class="row">
    <label>API URL: <input id="api" /></label>
    <button id="apply">Apply</button>
  </div>
  <div class="row">
    <button id="ping">Ping</button>
    <button id="add">Dummy AddScore</button>
    <button id="get">Get Rankings (allTime, limit=10)</button>
  </div>
  <small>ブラウザコンソールに詳細ログが出ます</small>
  <pre id="out"></pre>

  <script>
    const out = document.getElementById('out');
    const apiInput = document.getElementById('api');
    // 既定URLは config.js で定義された window.RANKING_API_URL を採用
    const defaultUrl = (window.RANKING_API_URL || '');
    apiInput.value = defaultUrl;

    function log(obj) {
      out.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
    }

    document.getElementById('apply').onclick = () => {
      window.RANKING_API_URL = apiInput.value.trim();
      log({ applied: window.RANKING_API_URL });
    };

    document.getElementById('ping').onclick = async () => {
      const base = (apiInput.value || '').trim();
      if (!base) return log('API URL が未設定です');
      try {
        const k = (window.RANKING_SHARED_KEY || '');
        const res = await fetch(`${base}?action=ping&k=${encodeURIComponent(k)}`);
        const json = await res.json().catch(() => ({}));
        log(json);
      } catch (e) {
        log(String(e));
      }
    };

    document.getElementById('add').onclick = async () => {
      const base = (apiInput.value || '').trim();
      if (!base) return log('API URL が未設定です');
      const now = Date.now();
      const params = new URLSearchParams({
        action: 'addScore',
        name: 'DebugUser',
        score: '7',
        totalQuestions: '10',
        percentage: '70',
        timeSpent: '33',
        timestamp: String(now),
        userAgent: navigator.userAgent.substring(0,100),
        sessionId: Math.random().toString(36).slice(2)
      });
      const kAdd = (window.RANKING_SHARED_KEY || '');
      if (kAdd) params.append('k', kAdd);
      try {
        const res = await fetch(`${base}?${params.toString()}`);
        const json = await res.json().catch(() => ({}));
        log(json);
        if (json && json.success === false && (json.error === 'Unauthorized' || json.error === 'rate_limited')) {
          log({ note: 'サーバ応答: ' + json.error, response: json });
        }
      } catch (e) {
        log(String(e));
      }
    };

    document.getElementById('get').onclick = async () => {
      const base = (apiInput.value || '').trim();
      if (!base) return log('API URL が未設定です');
      try {
        const res = await fetch(`${base}?action=getRankings&period=allTime&limit=10`);
        const json = await res.json().catch(() => ({}));
        log(json);
      } catch (e) {
        log(String(e));
      }
    };
  </script>
</body>
</html>
