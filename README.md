# アシュタンガ ヨガ アーサナクイズ — 開発・運用ハンドブック（決定版 / Supabase 版）

このファイルだけ見れば、初見の AI/Coder（=codex）でも全体を把握し、即作業できます。

---
　
## 0. 要約（本番・構成・ステータス）

- 本番URL: `https://ashtanga-yoga-quiz.onrender.com`
- ホスティング: Render（Static Site）
- ランキング: **Supabase**（テーブル: `scores` / anon の **read & insert** を許可。厳密な認証は不要な軽量リーダーボード想定）
- クライアント: Vanilla JS（`index.html` で `config → supabase-js → ranking → quiz` の順に **defer** 読み）
- CI/QA: GitHub Actions “**QA - Ranking (Prod)**”（本番をフェッチして `[RANK]` ログ確認 / Supabase REST の GET/POST を検証し、Summaryに QA Output を掲載）

---

## 1. 役割分担（人間 ↔ ChatGPT ↔ codex）

- **人間**: Supabase と Render の Web UI 操作（鍵の貼り付け、RLS/CORS設定、デプロイ確認）
- **ChatGPT**: codex に貼る指示ブロック作成・レビュー
- **codex**: リポジトリ内の全ファイル作業（編集/コミット/プッシュ）

原則: “Webコンソール操作は人間”、 “Git とファイル操作は codex”。

---

## 2. フロント構成（要点）

- `index.html`: `<head>` 末尾 or `<body>` 末尾で **defer** 読み  
  読み込み順: `js/config.js` → `@supabase/supabase-js` → `js/ranking.js` → `js/quiz.js`
- `js/config.js`: **Supabase URL と anon key** を公開値として定義（サービスロール鍵は使わない/置かない）
- `js/ranking.js`:  
  - Supabase クライアント生成  
  - `getTop(limit=10)` と `submitScore({ name, score, total_questions, time_spent })` を提供  
  - 失敗時はローカルランキングにフォールバック（`[RANK]` ログ出力）
- `js/quiz.js`:  
  - クイズ本体。結果表示時に `submitScore(...)` を呼ぶ。  
  - ランキングモーダルを開くと `getTop()` で最新 10 件を表示。

---

## 3. データストア（Supabase）

### 3.1 テーブル定義（DDL; SQL エディタで実行）

```sql
create table if not exists public.scores (
  id               bigint generated by default as identity primary key,
  name             text not null check (char_length(name) between 1 and 24),
  score            integer not null check (score >= 0),
  total_questions  integer not null check (total_questions between 1 and 50),
  percentage       numeric generated always as (case when total_questions > 0 then (score * 100.0) / total_questions else 0 end) stored,
  time_spent       integer not null check (time_spent between 1 and 1800), -- 秒: 最大30分
  created_at       timestamptz not null default now()
);

create index if not exists scores_created_at_idx on public.scores (created_at desc);
create index if not exists scores_percentage_idx on public.scores (percentage desc);
3.2 RLS（Row Level Security）
RLS を有効化し、anon に対して「読み取り（全件可）」と「挿入（チェック付き）」を許可します。

sql
コードをコピーする
alter table public.scores enable row level security;

drop policy if exists scores_select_anon on public.scores;
create policy scores_select_anon
on public.scores for select
to anon
using (true);

drop policy if exists scores_insert_anon on public.scores;
create policy scores_insert_anon
on public.scores for insert
to anon
with check (
  char_length(name) between 1 and 24
  and score >= 0
  and total_questions between 1 and 50
  and time_spent between 1 and 1800
);
メモ: percentage は 生成列 なのでクライアントから受け取りません（改ざん防止）。

3.3 CORS
Auth > URL Configuration > Allowed Redirect URLs / Additional Redirect URLs / Allowed CORS Origins に以下を追加

https://ashtanga-yoga-quiz.onrender.com

http://localhost:5500（ローカル開発時; 必要に応じて）

4. フロント設定（js/config.js のテンプレ）
html
コードをコピーする
<!-- index.html（読み込み例） -->
<script defer src="js/config.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script defer src="js/ranking.js"></script>
<script defer src="js/quiz.js"></script>
js
コードをコピーする
// js/config.js
// ⛳ 公開可能な anon 鍵のみ。service_role は絶対に置かない。
window.SUPABASE_URL = "https://xxxxxxxxxxxx.supabase.co";
window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9....";
window.RANKING_TOP_LIMIT = 10; // 表示件数
5. ランキング API（js/ranking.js の要点）
js
コードをコピーする
// js/ranking.js
const supabase = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

async function getTop(limit = window.RANKING_TOP_LIMIT || 10) {
  try {
    const { data, error } = await supabase
      .from("scores")
      .select("name, score, total_questions, percentage, time_spent, created_at")
      .order("percentage", { ascending: false })
      .order("time_spent", { ascending: true })
      .order("created_at", { ascending: false })
      .limit(limit);
    if (error) throw error;
    console.log("[RANK] GET ok:", data?.length ?? 0);
    return data ?? [];
  } catch (e) {
    console.warn("[RANK] GET fail → fallback local", e);
    return getTopFromLocal(); // 実装済み前提
  }
}

async function submitScore({ name, score, total_questions, time_spent }) {
  try {
    const { error } = await supabase.from("scores").insert([{ name, score, total_questions, time_spent }]);
    if (error) throw error;
    console.log("[RANK] POST ok");
    return true;
  } catch (e) {
    console.warn("[RANK] POST fail → store local", e);
    return saveLocal({ name, score, total_questions, time_spent }); // 実装済み前提
  }
}

// 他モジュールで使う
window.rankingSystem = { getTop, submitScore };
6. QA（自動検証）
GitHub Actions “QA - Ranking (Prod)” が以下を行います。

本番 URL にアクセス（HTTP 200 と [RANK] の存在をざっくり確認）

Supabase REST で GET /rest/v1/scores?select=* が 200 になるか検証

ダミーの POST → 直後に DELETE（クリーンアップ）
すべての結果を Summary（QA Output） に掲載

Secrets 必須：

SUPABASE_URL（例: https://xxxxxxxxxxxx.supabase.co）

SUPABASE_ANON_KEY

SUPABASE_REST_URL（$SUPABASE_URL/rest/v1 を推奨）

yaml
コードをコピーする
# .github/workflows/qa-ranking.yml
name: QA - Ranking (Prod)
on: [workflow_dispatch, push]

jobs:
  qa:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }

      - name: Check Prod & Supabase REST
        env:
          PROD_URL: https://ashtanga-yoga-quiz.onrender.com
          SUPABASE_REST_URL: ${{ secrets.SUPABASE_REST_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          set -euo pipefail
          echo "## QA Output" >> $GITHUB_STEP_SUMMARY

          echo "### [1] PROD Page" >> $GITHUB_STEP_SUMMARY
          curl -sS -o /dev/null -w "%{http_code}\n" "$PROD_URL" | tee /tmp/status.txt
          echo "HTTP: $(cat /tmp/status.txt)" >> $GITHUB_STEP_SUMMARY

          echo "### [2] Supabase GET" >> $GITHUB_STEP_SUMMARY
          curl -sS -H "apikey: $SUPABASE_ANON_KEY" \
               -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
               "$SUPABASE_REST_URL/scores?select=name,score,total_questions,percentage,time_spent,created_at&limit=1" \
               | tee /tmp/get.json
          echo "\n\`\`\`json" >> $GITHUB_STEP_SUMMARY
          cat /tmp/get.json >> $GITHUB_STEP_SUMMARY
          echo "\n\`\`\`" >> $GITHUB_STEP_SUMMARY

          echo "### [3] Supabase POST→DELETE" >> $GITHUB_STEP_SUMMARY
          NEW=$(
            curl -sS -X POST "$SUPABASE_REST_URL/scores" \
              -H "apikey: $SUPABASE_ANON_KEY" \
              -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
              -H "Content-Type: application/json" \
              -d '{"name":"QAUser","score":7,"total_questions":10,"time_spent":42}' \
              | jq -r '.[0].id'
          )
          echo "Inserted id: $NEW" >> $GITHUB_STEP_SUMMARY

          curl -sS -X DELETE "$SUPABASE_REST_URL/scores?id=eq.$NEW" \
              -H "apikey: $SUPABASE_ANON_KEY" \
              -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
              -o /dev/null

          echo "Deleted id: $NEW" >> $GITHUB_STEP_SUMMARY
7. 運用ランブック（よくある事象）
CSS MIME 警告: css/style.css を参照しているか（styles.css ではない）。

GET/POST 401/403: RLS/ポリシー/anon 権限/CORS を確認（Sec.3）。

STRICT/undefined 表示: js/config.js の URL/Key 未設定 or 誤り。

Actions 失敗: Summary の QA Output を確認（Sec.6 の 3 ステップでどこが落ちているか）。

8. 変更履歴（要点）
✅ ランキングを GAS→Supabase に移行（anon read/insert + 生成列 percentage）

✅ 本番検証を GitHub Actions に集約（REST の GET/POST を Summary に出力）

🧹 GAS 記述を本文から撤去（付録へ移動）

付録（旧ドキュメントのバックアップ）
<details><summary>旧 README（バックアップ）</summary>
参照: README.before-merge.md

</details> <details><summary>旧 CLAUDE.md（バックアップ）</summary>
参照: CLAUDE.before-merge.md

</details>
TODO（今後の予定）
 Instagram ストーリーズ シェア機能

 音声読み上げ（TTS）

 カテゴリ別出題モード

 詳細解説モード

 多言語化（英語・サンスクリット語）

作成者: YOGA LIFE sumsuun
ウェブサイト: https://ashtanga-yoga-quiz.onrender.com

bash
コードをコピーする
### END README.md

---

### BEGIN qa-ranking.yml
```yaml
name: QA - Ranking (Prod)
on: [workflow_dispatch, push]

jobs:
  qa:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }

      - name: Check Prod & Supabase REST
        env:
          PROD_URL: https://ashtanga-yoga-quiz.onrender.com
          SUPABASE_REST_URL: ${{ secrets.SUPABASE_REST_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          set -euo pipefail
          echo "## QA Output" >> $GITHUB_STEP_SUMMARY

          echo "### [1] PROD Page" >> $GITHUB_STEP_SUMMARY
          curl -sS -o /dev/null -w "%{http_code}\n" "$PROD_URL" | tee /tmp/status.txt
          echo "HTTP: $(cat /tmp/status.txt)" >> $GITHUB_STEP_SUMMARY

          echo "### [2] Supabase GET" >> $GITHUB_STEP_SUMMARY
          curl -sS -H "apikey: $SUPABASE_ANON_KEY" \
               -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
               "$SUPABASE_REST_URL/scores?select=name,score,total_questions,percentage,time_spent,created_at&limit=1" \
               | tee /tmp/get.json
          echo "\n\`\`\`json" >> $GITHUB_STEP_SUMMARY
          cat /tmp/get.json >> $GITHUB_STEP_SUMMARY
          echo "\n\`\`\`" >> $GITHUB_STEP_SUMMARY

          echo "### [3] Supabase POST→DELETE" >> $GITHUB_STEP_SUMMARY
          NEW=$(
            curl -sS -X POST "$SUPABASE_REST_URL/scores" \
              -H "apikey: $SUPABASE_ANON_KEY" \
              -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
              -H "Content-Type: application/json" \
              -d '{"name":"QAUser","score":7,"total_questions":10,"time_spent":42}' \
              | jq -r '.[0].id'
          )
          echo "Inserted id: $NEW" >> $GITHUB_STEP_SUMMARY

          curl -sS -X DELETE "$SUPABASE_REST_URL/scores?id=eq.$NEW" \
              -H "apikey: $SUPABASE_ANON_KEY" \
              -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
              -o /dev/null

          echo "Deleted id: $NEW" >> $GITHUB_STEP_SUMMARY
END qa-ranking.yml


